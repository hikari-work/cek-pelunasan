<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Telegram Mini App - Tabungan</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .search-container {
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background-color: var(--tg-theme-bg-color, #ffffff);
            z-index: 100;
            padding-bottom: 10px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .limit-notice {
            font-size: 13px;
            color: var(--tg-theme-hint-color, #666666);
            margin-top: 5px;
        }

        .savings-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .savings-card {
            border: 1px solid var(--tg-theme-button-color, #e0e0e0);
            border-radius: 12px;
            padding: 16px;
            background-color: var(--tg-theme-secondary-bg-color, #f8f9fa);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .savings-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .loading, .no-results {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .results-count {
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
        }

        .saldo-label {
            font-weight: bold;
        }
    </style>
</head>
<body>
<h1>Data Tabungan</h1>

<div class="search-container">
    <input type="text" id="searchInput" class="search-input"
           placeholder="Cari berdasarkan No Rekening atau Nama" autocomplete="off">
    <div class="limit-notice">Menampilkan maksimal 100 hasil</div>
</div>

<div id="resultsCount" class="results-count"></div>
<div id="loadingIndicator" class="loading" style="display: none;">Mencari data...</div>

<div id="savingsList" class="savings-list"></div>

<div id="noResults" class="no-results" style="display: none;">
    <h3>Tidak ada data ditemukan</h3>
    <p>Coba gunakan kata kunci yang berbeda</p>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const searchInput = document.getElementById('searchInput');
    const savingsList = document.getElementById('savingsList');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noResults = document.getElementById('noResults');
    const resultsCount = document.getElementById('resultsCount');

    let searchTimeout;
    let currentSearchTerm = '';

    function formatCurrency(amount) {
        if (!amount || isNaN(amount)) return 'Rp 0';
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(amount);
    }

    function createSavingsCard(s) {
        const bookBalance = Number(s.balance || 0) + Number(s.transaction || 0);
        const minBalance = Number(s.minimumBalance || 0);
        const blockBalance = Number(s.blockingBalance || 0);
        const effectiveBalance = bookBalance - minBalance - blockBalance;

        return `
            <div class="savings-card" data-account-id="${s.tabId}">
                <div><strong>ðŸ‘¤ ${s.name || 'N/A'}</strong></div>
                <div>No. Rek: <code>${s.tabId || '-'}</code></div>
                <div>Alamat: ${s.address || '-'}</div>
                <br/>
                <div class="saldo-label">ðŸ’° Saldo:</div>
                <ul>
                    <li>Buku: ${formatCurrency(bookBalance)}</li>
                    <li>Minimum: ${formatCurrency(minBalance)}</li>
                    <li>Blokir: ${formatCurrency(blockBalance)}</li>
                    <li><strong>Efektif:</strong> <code>${formatCurrency(effectiveBalance)}</code></li>
                </ul>
            </div>
        `;
    }

    function updateResultsCount(count, searchTerm) {
        let countText = searchTerm
            ? `Ditemukan ${count} hasil untuk "${searchTerm}"`
            : `Menampilkan ${count} data`;

        if (count === 100) {
            countText += ' (maksimal 100)';
        }

        resultsCount.textContent = countText;
    }

    function performSearch(searchTerm) {
        if (currentSearchTerm === searchTerm) return;
        currentSearchTerm = searchTerm;

        loadingIndicator.style.display = 'block';
        savingsList.style.display = 'none';
        noResults.style.display = 'none';

        const url = `/api/search/tabungan?searchTerm=${encodeURIComponent(searchTerm.trim())}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                loadingIndicator.style.display = 'none';

                if (data && data.length > 0) {
                    savingsList.innerHTML = data.map(createSavingsCard).join('');
                    savingsList.style.display = 'grid';
                    noResults.style.display = 'none';
                    updateResultsCount(data.length, searchTerm);
                } else {
                    savingsList.style.display = 'none';
                    noResults.style.display = 'block';
                    updateResultsCount(0, searchTerm);
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                loadingIndicator.style.display = 'none';
                savingsList.style.display = 'none';
                noResults.style.display = 'block';
                resultsCount.textContent = 'Terjadi kesalahan saat mencari';
            });
    }

    window.addEventListener('DOMContentLoaded', () => {
        performSearch('');
    });

    searchInput.addEventListener('input', function () {
        const searchTerm = this.value;
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            performSearch(searchTerm);
        }, 200);
    });
</script>
</body>
</html>
