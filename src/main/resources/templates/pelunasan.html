<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .search-container {
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background-color: var(--tg-theme-bg-color, #ffffff);
            z-index: 100;
            padding-bottom: 10px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #0066aa);
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .repayment-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .repayment-card {
            border: 1px solid var(--tg-theme-button-color, #e0e0e0);
            border-radius: 12px;
            padding: 16px;
            background-color: var(--tg-theme-secondary-bg-color, #f8f9fa);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .repayment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: var(--tg-theme-button-color, #0088cc);
        }

        .repayment-card:active {
            transform: translateY(-1px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .customer-id {
            font-weight: bold;
            color: var(--tg-theme-button-color, #0088cc);
            font-size: 14px;
            background: rgba(0, 136, 204, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .customer-name {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--tg-theme-text-color, #000000);
        }

        .card-summary {
            space-y: 8px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .summary-item:last-child {
            border-bottom: none;
        }

        .summary-label {
            color: var(--tg-theme-hint-color, #666666);
            font-size: 14px;
            font-weight: 500;
        }

        .summary-value {
            font-weight: 600;
            font-size: 14px;
            text-align: right;
        }

        .amount {
            color: var(--tg-theme-button-color, #0088cc);
            font-weight: bold;
        }

        .click-hint {
            position: absolute;
            bottom: 8px;
            right: 12px;
            font-size: 11px;
            color: var(--tg-theme-hint-color, #999999);
            opacity: 0.7;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--tg-theme-bg-color, #ffffff);
            margin: 20px;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--tg-theme-button-color, #e0e0e0);
            background-color: var(--tg-theme-button-color, #0088cc);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .modal-subtitle {
            font-size: 14px;
            margin: 5px 0 0 0;
            opacity: 0.9;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.8;
        }

        .modal-body {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--tg-theme-button-color, #0088cc);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--tg-theme-button-color, #0088cc);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            padding: 10px;
            background-color: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
        }

        .detail-label {
            color: var(--tg-theme-hint-color, #666666);
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .detail-value {
            font-weight: 600;
            font-size: 14px;
            word-break: break-word;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--tg-theme-hint-color, #999999);
        }

        .results-count {
            margin-bottom: 10px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
        }

        .limit-notice {
            margin-bottom: 10px;
            font-size: 12px;
            color: var(--tg-theme-hint-color, #888888);
            font-style: italic;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @media (max-width: 768px) {
            .repayment-list {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
            }
        }
    </style>
</head>
<body>
<h1>Data Pelunasan</h1>

<div class="search-container">
    <input
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="Cari berdasarkan No SPK atau Nama"
        autocomplete="off">
    <div class="limit-notice">Menampilkan maksimal 10 hasil</div>
</div>

<div id="resultsCount" class="results-count"></div>
<div id="loadingIndicator" class="loading" style="display: none;">
    Mencari data...
</div>

<div id="repaymentList" class="repayment-list">
    <div th:each="repayment : ${repayments}" class="repayment-card" th:data-customer-id="${repayment.customerId}" onclick="openModalFromCard(this)">
        <div class="card-header">
            <div class="customer-id" th:text="'ID: ' + ${repayment.customerId}"></div>
        </div>
        <div class="customer-name" th:text="${repayment.name}"></div>
        <div class="card-summary">
            <div class="summary-item">
                <span class="summary-label">Cabang:</span>
                <span class="summary-value" th:text="${repayment.branch}"></span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Alamat:</span>
                <span class="summary-value" th:text="${repayment.address}"></span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Baki Debet:</span>
                <span class="summary-value amount" th:text="'Rp ' + ${#numbers.formatInteger(repayment.amount, 3, 'POINT')}"></span>
            </div>
        </div>
        <div class="click-hint">Tap untuk detail</div>
    </div>
</div>

<div id="noResults" class="no-results" style="display: none;">
    <h3>Tidak ada data ditemukan</h3>
    <p>Coba gunakan kata kunci yang berbeda</p>
</div>

<!-- Modal -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <span class="close">&times;</span>
            <h2 class="modal-title" id="modalCustomerName"></h2>
            <p class="modal-subtitle" id="modalCustomerId"></p>
        </div>
        <div class="modal-body">
            <div class="detail-section">
                <div class="section-title">Informasi Pinjaman</div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">No SPK</span>
                        <span class="detail-value" id="detailCustomerId"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Nama</span>
                        <span class="detail-value" id="detailName"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Alamat</span>
                        <span class="detail-value" id="detailAddress"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Cabang</span>
                        <span class="detail-value" id="detailBranch"></span>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <div class="section-title">Informasi Produk</div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Produk</span>
                        <span class="detail-value" id="detailProduct"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Plafond</span>
                        <span class="detail-value amount" id="detailPlafond"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Tanggal Mulai</span>
                        <span class="detail-value" id="detailStartDate"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">LPDB</span>
                        <span class="detail-value" id="detailLpdb"></span>
                    </div>
                </div>
            </div>

            <div class="detail-section">
                <div class="section-title">Rincian Pelunasan</div>
                <div class="detail-grid">
                    <div class="detail-item">
                        <span class="detail-label">Pokok</span>
                        <span class="detail-value amount" id="detailAmount"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Tunggakan/Titipan Bunga</span>
                        <span class="detail-value amount" id="detailInterest"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Penalti Pelunasan</span>
                        <span class="detail-value amount" id="detailPenaltyLoan"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Denda Kredit</span>
                        <span class="detail-value amount" id="detailPenaltyRepayment"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Total Bayar</span>
                        <span class="detail-value amount" id="detailTotalPay"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const initData = tg.initData;
    console.log("Init Data:", initData);

    fetch("/api/initdata", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "initData=" + encodeURIComponent(initData)
    });

    const searchInput = document.getElementById('searchInput');
    const repaymentList = document.getElementById('repaymentList');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const noResults = document.getElementById('noResults');
    const resultsCount = document.getElementById('resultsCount');
    const modal = document.getElementById('detailModal');
    const closeBtn = document.getElementsByClassName('close')[0];

    let searchTimeout;
    let currentSearchTerm = '';
    let currentData = [];

    function formatCurrency(amount) {
        if (!amount) return 'Rp 0';
        return new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(amount);
    }

    function createRepaymentCard(repayment) {
        return `
                <div class="repayment-card" data-customer-id="${repayment.customerId}" onclick="openModalFromCard(this)">
                    <div class="card-header">
                        <div class="customer-id">SPK: ${repayment.customerId}</div>
                    </div>
                    <div class="customer-name">${repayment.name || 'N/A'}</div>
                    <div class="card-summary">
                        <div class="summary-item">
                            <span class="summary-label">Cabang:</span>
                            <span class="summary-value">${repayment.branch || 'N/A'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Alamat:</span>
                            <span class="summary-value">${repayment.address || 'N/A'}</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Baki Debet:</span>
                            <span class="summary-value amount">${formatCurrency(repayment.amount)}</span>
                        </div>
                    </div>
                    <div class="click-hint">Tap untuk detail</div>
                </div>
            `;
    }

    // New function to handle clicks from cards with data attributes
    function openModalFromCard(cardElement) {
        const customerId = cardElement.getAttribute('data-customer-id');
        openModal(customerId);
    }

    function openModal(customerId) {
        // First try to find the repayment in the loaded data from API
        let repayment = currentData.find(r => r.customerId === customerId);
        
        // If not found (such as for initial server-rendered data), fetch it from the API
        if (!repayment || !repayment.penaltyRepayment) {
            // Show loading state in the modal
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            
            // Fetch the repayment data from the API to get the correct penalty
            fetch(`/api/search/pelunasan?searchTerm=${customerId}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        repayment = data.find(r => r.customerId === customerId);
                        if (repayment) {
                            updateModalWithRepayment(repayment);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching repayment details:', error);
                });
        } else {
            updateModalWithRepayment(repayment);
        }
    }

    function updateModalWithRepayment(repayment) {
        // Populate modal with data
        document.getElementById('modalCustomerName').textContent = repayment.name || 'N/A';
        document.getElementById('modalCustomerId').textContent = 'ID: ' + repayment.customerId;

        document.getElementById('detailCustomerId').textContent = repayment.customerId;
        document.getElementById('detailName').textContent = repayment.name || 'N/A';
        document.getElementById('detailAddress').textContent = repayment.address || 'N/A';
        document.getElementById('detailBranch').textContent = repayment.branch || 'N/A';
        document.getElementById('detailProduct').textContent = repayment.product || 'N/A';
        document.getElementById('detailPlafond').textContent = formatCurrency(repayment.plafond);
        document.getElementById('detailStartDate').textContent = repayment.startDate ? new Intl.DateTimeFormat('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }).format(new Date(repayment.startDate.replace(/^(\d{4})(\d{2})(\d{2})$/, '$1-$2-$3'))) : 'N/A';
        document.getElementById('detailLpdb').textContent = repayment.lpdb || 'N/A';
        document.getElementById('detailAmount').textContent = formatCurrency(repayment.amount);
        document.getElementById('detailInterest').textContent = formatCurrency(repayment.interest);
        document.getElementById('detailPenaltyLoan').textContent = formatCurrency(repayment.penaltyLoan);
        document.getElementById('detailPenaltyRepayment').textContent = formatCurrency(repayment.penaltyRepayment);
        
        // Calculate total if not provided
        const total = repayment.totalPay || (
            (repayment.amount || 0) + 
            (repayment.interest || 0) + 
            (repayment.penaltyLoan || 0) + 
            (repayment.penaltyRepayment || 0)
        );
        document.getElementById('detailTotalPay').textContent = formatCurrency(total);

        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
    }

    // Modal event listeners
    closeBtn.onclick = closeModal;
    window.onclick = function(event) {
        if (event.target === modal) {
            closeModal();
        }
    };

    function updateResultsCount(count, searchTerm, isLimited = false) {
        let countText = '';
        if (searchTerm) {
            countText = `Ditemukan ${count} hasil untuk "${searchTerm}"`;
        } else {
            countText = `Menampilkan ${count} data`;
        }

        if (count === 10) {
            countText += ' (maksimal 10)';
        }

        resultsCount.textContent = countText;
    }

    function performSearch(searchTerm) {
        if (currentSearchTerm === searchTerm) return;
        currentSearchTerm = searchTerm;

        loadingIndicator.style.display = 'block';
        repaymentList.style.display = 'none';
        noResults.style.display = 'none';

        const url = searchTerm.trim()
            ? `/api/search/pelunasan?searchTerm=${encodeURIComponent(searchTerm.trim())}`
            : '/api/search/pelunasan?searchTerm=';

        fetch(url)
            .then(response => response.json())
            .then(data => {
                loadingIndicator.style.display = 'none';
                currentData = data;

                if (data && data.length > 0) {
                    repaymentList.innerHTML = data.map(createRepaymentCard).join('');
                    repaymentList.style.display = 'grid';
                    noResults.style.display = 'none';
                    updateResultsCount(data.length, searchTerm, data.length === 10);
                } else {
                    repaymentList.style.display = 'none';
                    noResults.style.display = 'block';
                    updateResultsCount(0, searchTerm);
                }
            })
            .catch(error => {
                console.error('Search error:', error);
                loadingIndicator.style.display = 'none';
                repaymentList.style.display = 'none';
                noResults.style.display = 'block';
                resultsCount.textContent = 'Terjadi kesalahan saat mencari';
            });
    }

    // Initialize current data from server-side rendered content
    window.addEventListener('DOMContentLoaded', function() {
        // Extract data from the rendered cards
        const cards = document.querySelectorAll('.repayment-card');

        // Initialize currentData with rendered cards data
        currentData = Array.from(cards).map(card => {
            const customerId = card.getAttribute('data-customer-id');
            const name = card.querySelector('.customer-name').textContent;
            const branch = card.querySelector('.summary-item:nth-child(1) .summary-value').textContent;
            const address = card.querySelector('.summary-item:nth-child(2) .summary-value').textContent;
            const amountText = card.querySelector('.amount').textContent;

            return {
                customerId: customerId,
                name: name,
                branch: branch,
                address: address,
                amount: parseInt(amountText.replace(/[^\d]/g, '')),
            };
        });

        // Initialize results count
        updateResultsCount(cards.length, '', cards.length === 10);
    });

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value;

        clearTimeout(searchTimeout);

        searchTimeout = setTimeout(() => {
            performSearch(searchTerm);
        }, 100);
    });

    searchInput.addEventListener('input', function() {
        if (this.value === '') {
            clearTimeout(searchTimeout);
            performSearch('');
        }
    });

    // Make functions global
    window.openModal = openModal;
    window.openModalFromCard = openModalFromCard;
</script>
</body>
</html>