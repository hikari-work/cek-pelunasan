name: Build GraalVM native image (Maven)

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-native:
    runs-on: ubuntu-latest
    steps:
        -   uses: actions/checkout@v4

        -   name: Set up GraalVM
            uses: graalvm/setup-graalvm@v1
            with:
                java-version: '21'
                distribution: 'graalvm-community'
                cache: 'maven'

        -   name: Build native image
            run: mvn -Pnative clean native:compile

        -   name: Extract app name
            id: app
            run: |
                APP_NAME=$(mvn help:describe -Dplugin=org.springframework.boot:spring-boot-maven-plugin -q | grep "spring-boot-app" || echo "spring-boot-app")
                echo "name=$(ls -1 target/ | grep -v -E '.jar|.txt|maven-archiver' | head -1)" >> $GITHUB_OUTPUT

        -   name: Create Release
            uses: softprops/action-gh-release@v1
            with:
                files: target/spring-boot-app
                draft: false
                prerelease: false
                generate_release_notes: true
            env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}